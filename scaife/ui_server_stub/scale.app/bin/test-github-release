#!/bin/bash

# Script to create a scaife-scale release and test it.  Takes no arguments

# <legal>
# SCALe version r.6.5.5.1.A
# 
# Copyright 2021 Carnegie Mellon University.
# 
# NO WARRANTY. THIS CARNEGIE MELLON UNIVERSITY AND SOFTWARE ENGINEERING
# INSTITUTE MATERIAL IS FURNISHED ON AN "AS-IS" BASIS. CARNEGIE MELLON
# UNIVERSITY MAKES NO WARRANTIES OF ANY KIND, EITHER EXPRESSED OR
# IMPLIED, AS TO ANY MATTER INCLUDING, BUT NOT LIMITED TO, WARRANTY OF
# FITNESS FOR PURPOSE OR MERCHANTABILITY, EXCLUSIVITY, OR RESULTS
# OBTAINED FROM USE OF THE MATERIAL. CARNEGIE MELLON UNIVERSITY DOES NOT
# MAKE ANY WARRANTY OF ANY KIND WITH RESPECT TO FREEDOM FROM PATENT,
# TRADEMARK, OR COPYRIGHT INFRINGEMENT.
# 
# Released under a MIT (SEI)-style license, please see COPYRIGHT file or
# contact permission@sei.cmu.edu for full terms.
# 
# [DISTRIBUTION STATEMENT A] This material has been approved for public
# release and unlimited distribution.  Please see Copyright notice for
# non-US Government use and distribution.
# 
# DM19-1274
# </legal>

if [ ! -d "./ui_server_stub" ]; then
   echo "Must be invoked from scaife directory"
   exit 1
fi
if [ -d "./packages" ]; then
   echo "Please remove ./packages before proceeding"
   exit 1
fi

# We must copy this program to outside scaife because it will overwrite itself and fail otherwise.
if [ $0 = ./ui_server_stub/scale.app/bin/test-github-release ]; then
    echo "This script will not work when run within the scaife directory"
    echo "because package.py will add markings which makes the script work incorrectly on some (not all) machines."
    echo "Please copy this script to somewhere outside scaife"
    echo "and run it from there"
    exit 1
fi

export SCAIFE_DIR=`pwd`
# Create release tarball
./ui_server_stub/scale.app/package.py --top-dir ${PWD} --target scaife-scale-online

# Extract into packages/tmp dir
cd packages
mkdir tmp
cd tmp
tar xzf ../*.tar.gz
cd scaife

# Check for SCALe markings
for file in ./start.sh \
            ./helpers/remove_yaml_examples.py \
            ./ui_server_stub/scale.app/start.sh \
             ./ui_server_stub/scale.app/doc/Welcome.md ; do
    grep "DM19-1274" $file > /dev/null  # SCALe markings
    if [ ! 0 = $? ]; then
        echo $file "has incorrect markings"
    fi
done

# Check for SCAIFe manual markings
for file in ./ui_server_stub/scale.app/doc/SCAIFE-Welcome.md; do
    grep "DM20-0043" $file > /dev/null  # SCAIFE manual markings
    if [ ! 0 = $? ]; then
        echo $file "has incorrect markings"
    fi
done


# Launch container
docker-compose -f docker-compose.yml up -d --build scale
sleep 15  # wait for SCALe to come up

# Test container by creating some projects
echo "Creating projects"
docker-compose exec scale ./scripts/automation/create_basic_project.py
docker-compose exec scale ./scripts/automation/create_basic_testsuite_project.py

echo "Testing"
docker-compose exec scale ./bin/test-link
docker-compose exec scale ./bin/test-python
docker-compose exec scale ./bin/test-ruby
# Run the simplest Selenium test
docker-compose exec scale ./bin/test-selenium-nostart -Dtest=TestWebAppCoreScenariosRemote\#testAlertsPresentTarGz
# All of Selenium, which currently takes >40m
#docker-compose exec scale ./bin/test-selenium-nostart

echo "Cleaning up"
# To clean up container
docker-compose down

# To clean up tarball extraction
cd ${SCAIFE_DIR}
rm -rf packages/tmp

# To clean up from release tarball:
cd ${SCAIFE_DIR}
rm -rf packages

# package.py also modifies most of the files, you may wish to reset them afterwards
git checkout --force
pushd ui_server_stub/scale.app/ ; git checkout --force ; popd
pushd stats_server_stub/swagger_server/rapidclass_scripts/ ; git checkout --force ; popd
pushd datahub_server_stub/swagger_server/rapidclass_scripts/ ; git checkout --force ; popd

rm /tmp/test-github-release

exit 0
