#!/bin/sh

# Script to create a scaife-scale release and test it.  Takes no arguments

# <legal>
# SCALe version r.6.7.0.0.A
# 
# Copyright 2021 Carnegie Mellon University.
# 
# NO WARRANTY. THIS CARNEGIE MELLON UNIVERSITY AND SOFTWARE ENGINEERING
# INSTITUTE MATERIAL IS FURNISHED ON AN "AS-IS" BASIS. CARNEGIE MELLON
# UNIVERSITY MAKES NO WARRANTIES OF ANY KIND, EITHER EXPRESSED OR
# IMPLIED, AS TO ANY MATTER INCLUDING, BUT NOT LIMITED TO, WARRANTY OF
# FITNESS FOR PURPOSE OR MERCHANTABILITY, EXCLUSIVITY, OR RESULTS
# OBTAINED FROM USE OF THE MATERIAL. CARNEGIE MELLON UNIVERSITY DOES NOT
# MAKE ANY WARRANTY OF ANY KIND WITH RESPECT TO FREEDOM FROM PATENT,
# TRADEMARK, OR COPYRIGHT INFRINGEMENT.
# 
# Released under a MIT (SEI)-style license, please see COPYRIGHT file or
# contact permission@sei.cmu.edu for full terms.
# 
# [DISTRIBUTION STATEMENT A] This material has been approved for public
# release and unlimited distribution.  Please see Copyright notice for
# non-US Government use and distribution.
# 
# DM19-1274
# </legal>

if [ ! -d "./ui_server_stub" ]; then
   echo "Must be invoked from scaife directory"
   exit 1
fi
if [ -d "./packages" ]; then
   echo "Please remove ./packages before proceeding"
   exit 1
fi

# We must copy this program to outside scaife because it will overwrite itself and fail otherwise.
if [ $0 = ./ui_server_stub/scale.app/bin/test-github-release ]; then
    echo "This script will not work when run within the scaife directory"
    echo "because package.py will add markings which makes the script work incorrectly on some (not all) machines."
    echo "Please copy this script to somewhere outside scaife"
    echo "and run it from there"
    exit 1
fi

export SCAIFE_DIR=`pwd`
# Create release tarball
./ui_server_stub/scale.app/package.py --top-dir ${PWD} --target scaife-scale-online

# Now do container testing
./ui_server_stub/scale.app/bin/test-github-tar  ./packages/*.tar.gz

# To clean up from release tarball:
cd ${SCAIFE_DIR}
rm -rf packages

# package.py also modifies most of the files, you may wish to reset them afterwards
git checkout --force
pushd ui_server_stub/scale.app/ ; git checkout --force ; popd
pushd stats_server_stub/swagger_server/rapidclass_scripts/ ; git checkout --force ; popd
pushd datahub_server_stub/swagger_server/rapidclass_scripts/ ; git checkout --force ; popd

rm /tmp/test-github-release

exit 0
